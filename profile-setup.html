<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Setup</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-100 min-h-screen flex justify-center items-start p-8">

<div class="bg-white w-full max-w-6xl rounded-3xl shadow-2xl p-10 mt-10">
  <h2 class="text-3xl font-bold text-center text-blue-700 mb-10">Profile Setup</h2>

  <div class="flex flex-col md:flex-row gap-12">

    <!-- Left Panel -->
    <div class="flex flex-col items-center md:w-1/3 bg-blue-50 p-6 rounded-2xl shadow-inner">
      <div class="relative w-36 h-36 mb-4">
        <img id="profilePic" src="https://via.placeholder.com/150" alt="Profile" class="w-36 h-36 rounded-full object-cover border-4 border-blue-300">
        <label for="uploadPic" class="absolute bottom-0 right-0 bg-blue-500 text-white text-sm px-4 py-2 rounded-full cursor-pointer hover:bg-blue-600 transition">Upload</label>
        <input type="file" id="uploadPic" accept="image/*" class="hidden">
      </div>
      <!-- Display User ID -->
      <p class="text-gray-700 font-medium mb-4">User ID: <span id="displayUserId">00000</span></p>
      <button id="logoutBtn" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition">Logout</button>
    </div>

    <!-- Right Panel -->
    <div class="md:w-2/3 bg-white p-8 rounded-2xl shadow-inner">
      <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Gender -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">เพศ</label>
          <select id="gender" class="w-full border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300">
            <option value="male">ชาย</option>
            <option value="female">หญิง</option>
          </select>
        </div>

        <!-- Age -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">อายุ</label>
          <input type="number" id="age" placeholder="กรอกอายุ" class="w-full border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300" required>
        </div>

        <!-- Height -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">ส่วนสูง (cm)</label>
          <input type="number" id="height" placeholder="กรอกส่วนสูง" class="w-full border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300" required>
        </div>

        <!-- Weight -->
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block text-gray-700 font-medium mb-2">นํ้าหนัก</label>
            <input type="number" placeholder="กรอกนํ้าหนัก" id="weight" class="w-full border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300" required>
          </div>
          <div class="w-28">
            <label class="block text-gray-700 font-medium mb-2">หน่วย</label>
            <select id="weightUnit" class="w-full border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300">
              <option value="kg">kg</option>
            </select>
          </div>
        </div>

        <!-- Activity Level -->
        <div class="md:col-span-2">
          <label class="block text-gray-700 font-medium mb-2">กิจวัตรในชีวิตประจําวัน</label>
          <select id="activity" class="w-full border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300">
            <option value="low">ทํางาน/เรียน/ไม่ได้ออกกําลังกายเลย</option>
            <option value="medium">ออกกําลังกายปานกลาง 3-5 วัน/สัปดาห์</option>
            <option value="moderate">ออกกําลังกายหนัก 6-7 วัน/สัปดาห์</option>
            <option value="heavy">ออกกําลังกายมาก ทุกวันเช้าและเย็น</option>
          </select>
        </div>

        <!-- Daily Water Goal -->
        <div class="flex gap-4 md:col-span-2">
          <div class="flex-1">
            <label class="block text-gray-700 font-medium mb-2">มิลลิลิตรตั้งเป้าที่จะดื่ม</label>
            <input type="text" id="dailyGoal" class="w-full border border-gray-300 px-4 py-3 rounded-xl bg-gray-100" readonly>
          </div>
          <div class="w-28">
            <label class="block text-gray-700 font-medium mb-2">หน่วย</label>
            <select id="waterUnit" class="w-full border border-gray-300 px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-300">
              <option value="ml">ml</option>
            </select>
          </div>
        </div>

        <!-- Save Button -->
        <div class="md:col-span-2">
          <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-xl hover:bg-blue-600 transition">บันทึกโปรไฟล์</button>
        </div>

      </form>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyD_1IlE_sztfraOrwx1nbO0ETwYFVLQbZU",
    authDomain: "water-tracker-db-d0d45.firebaseapp.com",
    projectId: "water-tracker-db-d0d45",
    storageBucket: "water-tracker-db-d0d45.firebasestorage.app",
    messagingSenderId: "382656566913",
    appId: "1:382656566913:web:b1a3a973437c6077dd1f80",
    measurementId: "G-VSTQ6P15XG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Generate or get User ID
  let userId = localStorage.getItem("userId");
  if(!userId){
    userId = 'user' + Math.floor(Math.random()*1000000);
    localStorage.setItem("userId", userId);
  }
  document.getElementById("displayUserId").textContent = userId;

  // Calculate daily water goal
  function calculateDailyWater(weight, activityLevel){
    if(!weight) return 0;
    let base = weight*35; // ml per kg
    let multiplier = 1;
    switch(activityLevel){
      case "low": multiplier=1; break;
      case "medium": multiplier=1.2; break;
      case "moderate": multiplier=1.4; break;
      case "heavy": multiplier=1.6; break;
    }
    return Math.round(base*multiplier);
  }

  function updateDailyGoal(){
    const weight = parseFloat(document.getElementById("weight").value);
    const activity = document.getElementById("activity").value;
    document.getElementById("dailyGoal").value = calculateDailyWater(weight, activity);
  }

  document.getElementById("weight").addEventListener("input", updateDailyGoal);
  document.getElementById("activity").addEventListener("change", updateDailyGoal);

  // Save profile
  document.getElementById("profileForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const gender = document.getElementById("gender").value;
    const age = parseInt(document.getElementById("age").value);
    const height = parseFloat(document.getElementById("height").value);
    const weight = parseFloat(document.getElementById("weight").value);
    const activity = document.getElementById("activity").value;
    const dailyGoal = parseInt(document.getElementById("dailyGoal").value);

    try{
      await setDoc(doc(db,"profiles",userId), {
        userId, gender, age, height, weight, activity, dailyGoal, createdAt: serverTimestamp()
      });
      alert("บันทึกโปรไฟล์สำเร็จ");
      window.location.href = "watertracker.html"; // เด้งไปหน้า watertracker
    }catch(err){
      console.error(err);
      alert("เกิดข้อผิดพลาดในการบันทึก");
    }
  });

  // Logout button
document.getElementById("logoutBtn").addEventListener("click", () => {
  // ลบ userId ออกจาก localStorage (optional แต่ช่วยให้ logout จริง)
  localStorage.removeItem("userId");
  // ไปหน้า login
  window.location.href = "loginwater.html";
});
</script>

</body>
</html>
