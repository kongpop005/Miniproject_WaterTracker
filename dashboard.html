<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water Tracker Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_1IlE_sztfraOrwx1nbO0ETwYFVLQbZU",
  authDomain: "water-tracker-db-d0d45.firebaseapp.com",
  projectId: "water-tracker-db-d0d45",
  storageBucket: "water-tracker-db-d0d45.firebasestorage.app",
  messagingSenderId: "382656566913",
  appId: "1:382656566913:web:b1a3a973437c6077dd1f80",
  measurementId: "G-VSTQ6P15XG"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const userId = localStorage.getItem("userId") || "user123";
const dailyGoal = 2000;

// Charts
const ctxMonth = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(ctxMonth, {
  type: 'bar',
  data: { labels: Array.from({length:31}, (_,i)=>i+1), datasets:[{label:'น้ำที่ดื่มรายวัน', data:Array(31).fill(0), backgroundColor:'rgba(59,130,246,0.7)'}]},
  options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
});

const ctxYear = document.getElementById('yearlyChart').getContext('2d');
const yearlyChart = new Chart(ctxYear, {
  type:'bar',
  data:{ labels:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], datasets:[{label:'น้ำที่ดื่มรายเดือน', data:Array(12).fill(0), backgroundColor:'rgba(16,185,129,0.7)'}]},
  options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
});

// Realtime listener
const q = query(collection(db,"drinkRecords"), where("userId","==",userId));
onSnapshot(q,snapshot=>{
  const records = snapshot.docs.map(doc=>doc.data());
  renderWeekly(records);
  updateCharts(records);
});

function renderWeekly(records){
  const weeklyDiv = document.getElementById("weeklyRecords");
  weeklyDiv.innerHTML = '';
  const today = new Date();
  const dayOfWeek = today.getDay();
  const monday = new Date(today);
  monday.setDate(today.getDate()-((dayOfWeek+6)%7));

  for(let i=0;i<7;i++){
    const d = new Date(monday);
    d.setDate(monday.getDate()+i);
    const dayRecords = records.filter(r=>new Date(r.date).toDateString()===d.toDateString());
    const total = dayRecords.reduce((sum,r)=>sum+r.ml,0);
    const completed = total>=dailyGoal;
    const dayName=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i];
    weeklyDiv.innerHTML += `<div class="flex flex-col items-center p-2">
      <span class="font-medium">${dayName}</span>
      <span class="mt-2 px-2 py-1 rounded-full ${completed?'bg-green-500 text-white':'bg-gray-300 text-gray-700'}">${total} ml</span>
    </div>`;
  }
}

function updateCharts(records){
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  const monthData = Array(31).fill(0);
  const yearData = Array(12).fill(0);

  records.forEach(r=>{
    const d = new Date(r.date);
    if(d.getMonth()===currentMonth && d.getFullYear()===currentYear) monthData[d.getDate()-1]+=r.ml;
    if(d.getFullYear()===currentYear) yearData[d.getMonth()]+=r.ml;
  });

  monthlyChart.data.datasets[0].data = monthData;
  monthlyChart.update();

  yearlyChart.data.datasets[0].data = yearData;
  yearlyChart.update();
}
</script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-200 min-h-screen p-6">
<div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl p-8">
  <h2 class="text-4xl font-bold text-blue-700 mb-10 text-center">Dashboard</h2>

  <!-- Weekly record -->
  <div class="mb-10">
    <h3 class="text-2xl font-semibold text-blue-600 mb-4">สัปดาห์นี้</h3>
    <div id="weeklyRecords" class="flex justify-between"></div>
  </div>

  <!-- Monthly Chart -->
  <div class="mb-10">
    <canvas id="monthlyChart"></canvas>
  </div>

  <!-- Yearly Chart -->
  <div class="mb-10">
    <canvas id="yearlyChart"></canvas>
  </div>

  <div class="text-center">
    <button onclick="window.location.href='watertracker.html'" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
      Back to Tracker
    </button>
  </div>
</div>
</body>
</html>
