<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Password</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-blue-300 to-blue-500 flex items-center justify-center min-h-screen">

<div class="bg-white shadow-2xl rounded-3xl w-full max-w-md p-10 flex flex-col items-center">

  <h2 class="text-3xl font-extrabold text-blue-600 mb-4 text-center">ตั้งรหัสผ่านใหม่</h2>
  <p class="text-gray-600 text-center mb-8">กรอกรหัสผ่านใหม่ของคุณ</p>

  <form id="resetForm" class="w-full space-y-6">
    <div>
      <label for="newPassword" class="block text-gray-700 font-semibold mb-2">รหัสผ่านใหม่</label>
      <input type="password" id="newPassword" placeholder="กรอกรหัสผ่านใหม่" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <div>
      <label for="confirmPassword" class="block text-gray-700 font-semibold mb-2">ยืนยันรหัสผ่านใหม่</label>
      <input type="password" id="confirmPassword" placeholder="ยืนยันรหัสผ่านใหม่" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors">
      ตั้งรหัสผ่านใหม่
    </button>
  </form>

  <p class="text-center text-gray-600 mt-6">
    กลับไปหน้า 
    <a href="loginwater.html" class="text-blue-600 font-semibold hover:underline">ล็อกอิน</a>
  </p>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, verifyPasswordResetCode, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD_1IlE_sztfraOrwx1nbO0ETwYFVLQbZU",
  authDomain: "water-tracker-db-d0d45.firebaseapp.com",
  projectId: "water-tracker-db-d0d45",
  storageBucket: "water-tracker-db-d0d45.appspot.com",
  messagingSenderId: "382656566913",
  appId: "1:382656566913:web:b1a3a973437c6077dd1f80",
  measurementId: "G-VSTQ6P15XG"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// ดึง oobCode จาก URL
const urlParams = new URLSearchParams(window.location.search);
const actionCode = urlParams.get('oobCode');

if(!actionCode){
  alert("ลิงก์รีเซ็ตไม่ถูกต้อง");
  window.location.href = "loginwater.html";
}

// ตรวจสอบ oobCode
verifyPasswordResetCode(auth, actionCode)
  .then(email => {
    console.log("รหัสรีเซ็ตถูกต้องสำหรับ:", email);
  })
  .catch(err => {
    console.error(err);
    alert("ลิงก์รีเซ็ตไม่ถูกต้องหรือหมดอายุ");
    window.location.href = "loginwater.html";
  });

// ตั้งรหัสผ่านใหม่
document.getElementById("resetForm").addEventListener("submit", async e => {
  e.preventDefault();
  const newPassword = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmPassword").value;

  if(newPassword !== confirmPassword){
    alert("รหัสผ่านไม่ตรงกัน");
    return;
  }

  try {
    await confirmPasswordReset(auth, actionCode, newPassword);
    alert("เปลี่ยนรหัสผ่านเรียบร้อยแล้ว! ล็อกอินได้เลย");
    window.location.href = "loginwater.html";
  } catch (err) {
    console.error(err);
    alert("เกิดข้อผิดพลาด: " + err.message);
  }
});
</script>

</body>
</html>
